# =============================================================================
# SEMGREP CUSTOM RULES: Hardcoded Credentials Detection
# Catches credentials, tokens, and secrets in code
# =============================================================================

rules:
  # ---------------------------------------------------------------------------
  # API Keys and Tokens
  # ---------------------------------------------------------------------------
  - id: hardcoded-api-key
    patterns:
      - pattern-either:
          - pattern: |
              $KEY = "..."
          - pattern: |
              $KEY = '...'
          - pattern: |
              const $KEY = "..."
          - pattern: |
              let $KEY = "..."
          - pattern: |
              var $KEY = "..."
          - pattern: |
              $KEY: "..."
    pattern-regex: '(?i)(api[_-]?key|apikey|api[_-]?secret)\s*[=:]\s*["\'][a-zA-Z0-9_\-]{16,}'
    message: |
      Hardcoded API key detected. API keys should be stored in environment variables or a secrets manager.
      
      Recommendation:
      - Use process.env.API_KEY or similar
      - Store in .env file (which is gitignored)
      - Use a secrets manager for production
    severity: ERROR
    languages:
      - javascript
      - typescript
      - python
      - go
      - java
    metadata:
      category: security
      subcategory: credentials
      cwe: "CWE-798: Use of Hard-coded Credentials"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: HIGH

  # ---------------------------------------------------------------------------
  # AWS Credentials
  # ---------------------------------------------------------------------------
  - id: hardcoded-aws-credentials
    pattern-regex: |
      (?i)(aws[_-]?access[_-]?key[_-]?id|aws[_-]?secret[_-]?access[_-]?key)\s*[=:]\s*["\'][A-Z0-9]{16,}
    message: |
      Hardcoded AWS credentials detected. Never commit AWS credentials to source control.
      
      Recommendation:
      - Use AWS IAM roles or instance profiles
      - Use environment variables
      - Use AWS Secrets Manager
    severity: ERROR
    languages:
      - generic
    metadata:
      category: security
      subcategory: credentials
      cwe: "CWE-798: Use of Hard-coded Credentials"
      confidence: HIGH

  # ---------------------------------------------------------------------------
  # Generic Secrets
  # ---------------------------------------------------------------------------
  - id: hardcoded-secret-generic
    patterns:
      - pattern-either:
          - pattern: |
              $VAR = "..."
          - pattern: |
              $VAR: "..."
    pattern-regex: |
      (?i)(secret|password|passwd|pwd|token|auth[_-]?token|bearer|private[_-]?key)\s*[=:]\s*["'][^"']{8,}["']
    message: |
      Potential hardcoded secret detected. Secrets should never be committed to source control.
      
      Recommendation:
      - Use environment variables
      - Use a secrets manager (HashiCorp Vault, AWS Secrets Manager, etc.)
      - Use encrypted configuration files
    severity: WARNING
    languages:
      - javascript
      - typescript
      - python
      - go
      - java
      - ruby
      - php
    metadata:
      category: security
      subcategory: credentials
      cwe: "CWE-798: Use of Hard-coded Credentials"
      confidence: MEDIUM

  # ---------------------------------------------------------------------------
  # Database Connection Strings with Passwords
  # ---------------------------------------------------------------------------
  - id: hardcoded-database-password
    pattern-regex: |
      (?i)(mongodb|postgres|mysql|redis|amqp|mssql):\/\/[^:]+:[^@]+@
    message: |
      Database connection string with embedded password detected.
      
      Recommendation:
      - Use DATABASE_URL environment variable
      - Use separate environment variables for user and password
      - Use IAM authentication where supported
    severity: ERROR
    languages:
      - generic
    metadata:
      category: security
      subcategory: credentials
      cwe: "CWE-798: Use of Hard-coded Credentials"
      confidence: HIGH

  # ---------------------------------------------------------------------------
  # Private Keys
  # ---------------------------------------------------------------------------
  - id: hardcoded-private-key
    pattern-regex: |
      -----BEGIN (RSA |DSA |EC |OPENSSH |PGP )?PRIVATE KEY-----
    message: |
      Private key detected in source code. Private keys should never be committed.
      
      Recommendation:
      - Store keys in a secure key management system
      - Use environment variables to pass key file paths
      - Use cloud provider key management (AWS KMS, GCP KMS, etc.)
    severity: ERROR
    languages:
      - generic
    metadata:
      category: security
      subcategory: credentials
      cwe: "CWE-321: Use of Hard-coded Cryptographic Key"
      confidence: HIGH

  # ---------------------------------------------------------------------------
  # JWT Secrets
  # ---------------------------------------------------------------------------
  - id: hardcoded-jwt-secret
    patterns:
      - pattern-either:
          - pattern: jwt.sign($PAYLOAD, "...", ...)
          - pattern: jwt.verify($TOKEN, "...", ...)
          - pattern: jsonwebtoken.sign($PAYLOAD, "...", ...)
          - pattern: jsonwebtoken.verify($TOKEN, "...", ...)
    message: |
      Hardcoded JWT secret detected. JWT secrets should be stored securely.
      
      Recommendation:
      - Use process.env.JWT_SECRET
      - Use asymmetric keys (RS256) for production
      - Rotate secrets regularly
    severity: ERROR
    languages:
      - javascript
      - typescript
    metadata:
      category: security
      subcategory: credentials
      cwe: "CWE-798: Use of Hard-coded Credentials"
      confidence: HIGH

  # ---------------------------------------------------------------------------
  # OAuth/Auth0 Secrets
  # ---------------------------------------------------------------------------
  - id: hardcoded-oauth-secret
    pattern-regex: |
      (?i)(client[_-]?secret|oauth[_-]?secret|auth0[_-]?secret)\s*[=:]\s*["'][a-zA-Z0-9_\-]{20,}["']
    message: |
      Hardcoded OAuth/Auth0 secret detected.
      
      Recommendation:
      - Use environment variables
      - Use your auth provider's recommended configuration method
    severity: ERROR
    languages:
      - generic
    metadata:
      category: security
      subcategory: credentials
      cwe: "CWE-798: Use of Hard-coded Credentials"
      confidence: HIGH
